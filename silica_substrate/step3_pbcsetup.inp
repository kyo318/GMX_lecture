* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Apr, 28. 2024. JOBID=1428764408
* SETUP PERIODIC BOUNDARY CONDITION
*

DIMENS CHSIZE 5000000 MAXRES 5000000 MAXGRP 5000000

! Read topology and parameter files
stream toppar.str

! Read PSF and Coordinates
read psf  card name step1_nanomaterial.psf

read coor card name step1_nanomaterial.crd

!
! Rename all of nanomaterial to NM
!

set nseg = ?nseg

define target select all end
set segid = ?selsegi

rename segid NM select segid @segid end
if ?nseg .eq. 1 goto skip_rename
label do_rename
    define target select .not. segid NM end
    set segid = ?selsegi
    join NM @segid renumber

    if ?nseg .gt. 1 goto do_rename

label skip_rename



stream step1.1_user_input.str
stream step1_nanomaterial.str
calc A = 34.391
calc B = 34.0384
calc C = 41
set XTLtype = ORTHorhombic
if A eq @B set XTLtype = TETRagonal
if A eq @B if B eq @C set XTLtype = CUBIc
if impatch .ne. no then

   crystal define @XTLtype @A @B @C @{alpha} @{beta} @{gamma}

   open unit 10 read card name crystal_image.str
   crystal read unit 10 card
   open read unit 10 card name cubic.img
   read imag unit 10
   print images tran
   update imall
   open read card unit 10 name image.psf
   read image psf unit 10  
endif


!
! Setup PBC (Periodic Boundary Condition)
!


COOR CONVERT ALIGNED SYMMETRIC @A @B @C @alpha @beta @gamma

open read unit 10 card name crystal_image.str
CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL READ UNIT 10 CARD

!Image centering by residue
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele resname TIP3 end

!
! Nonbonded Options
!

system "python checkfft.py ?XTLA ?XTLB ?XTLC > checkfft.str"
stream checkfft.str


nbonds atom vatom vfswitch bycb -
       ctonnb 10.0 ctofnb 12.0 cutnb 16.0 cutim 16.0 -
       inbfrq -1 imgfrq -1 wmin 1.0 cdie eps 1.0 -
       ewald pmew fftx @fftx ffty @ffty fftz @fftz  kappa .34 spline order 6
energy

!
! cons fix all heavy atoms except generated water molecules and
! short minimization
!

cons fix sele .not. ( hydrogen .or. segid SOLV ) end


cons fix sele none end


!
! Write coordinates and system information
!

open write unit 10 card name step3_pbcsetup.psf
write  psf unit 10 card

open write unit 10 card name step3_pbcsetup.oldpsf
write  psf unit 10 card oldpsf

open write unit 10 card name step3_pbcsetup.pdb
write coor unit 10 pdb

open write unit 10 card name step3_pbcsetup.crd
write coor unit 10 card

if @?impatch .eq. 0 set impatch = no
open  write unit 90 card name step3_pbcsetup.str
write title unit 90
* set BoxType  = @BoxType
* set XTLtype  = @XTLtype
* set A = @A
* set B = @B
* set C = @C
* set Alpha = @Alpha
* set Beta  = @Beta
* set Gamma = @Gamma
* set impatch = @impatch
* set fftx  = @fftx
* set ffty  = @ffty
* set fftz  = @fftz
* set xcen  = @xcen
* set ycen  = @ycen
* set zcen  = @zcen
*

if impatch .eq. YES then
    system "python genimpsf_v2.py step3_pbcsetup.psf"
endif

stop
